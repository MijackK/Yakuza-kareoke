(()=>{"use strict";var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var o=e.g.document;if(!t&&o&&(o.currentScript&&(t=o.currentScript.src),!t)){var n=o.getElementsByTagName("script");if(n.length)for(var a=n.length-1;a>-1&&!t;)t=n[a--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})();const t=e.p+"66ad1dbd7ca0dbc79a26.png",o=e.p+"54905605f6af4abba1e1.png",n=e.p+"978028f3533655a2d87e.png",a=e.p+"4a20d8fb54006780b071.png",r=e.p+"b694b7e059e6fbe710b6.png",i=e.p+"38350e147f119113734c.png",c=Number((1497.5/3).toFixed(3));let d;const s={ArrowUp:document.createElement("img"),ArrowLeft:document.createElement("img"),ArrowRight:document.createElement("img"),ArrowDown:document.createElement("img")},l={ArrowUp:30,ArrowRight:83,ArrowLeft:130,ArrowDown:185};let u,p;s.ArrowUp.src=n,s.ArrowLeft.src=a,s.ArrowDown.src=r,s.ArrowRight.src=i;const m=document.createElement("img"),g={rapid:o,hold:t},y=(e,t)=>{const o=1897.5-e*c;u.fillStyle="blue",u.beginPath(),u.drawImage(s[t],o-22.5,l[t]-22.5,55,55),u.fill(),u.stroke()},h=(e,t,o,n,a,r)=>{m.src=g[a];const i=1897.5-o*c,p=i+n*c,y=i+n*c/2-25;let h;const f=r===d&&e>=t-.2;"hold"===a&&(h=f?50:55),"rapid"===a&&(h=f?50:55),u.font="40px serif",u.strokeStyle="rapid"===a?"blue":"#add8e6",u.lineWidth=10,u.beginPath(),u.arc(i,l[r],15.5,0,2*Math.PI),u.arc(p,l[r],15.5,0,2*Math.PI),u.stroke(),u.beginPath(),u.drawImage(s[r],i-22.5,l[r]-22.5,h,h),u.drawImage(m,y,l[r]-22.5,75,35),u.drawImage(s[r],p-22.5,l[r]-22.5,h,h),u.stroke()},f=(e,t)=>{u.clearRect(0,0,p.width,p.height),(e=>{for(let t=0;t<3;t+=1){const o=633*(t+1)-c*e%633;u.beginPath(),u.strokeStyle="gray",u.lineWidth=1,u.moveTo(o,15),u.lineTo(o,195),u.stroke()}})(e);for(let o=0;o<t.length;o+=1){const n=t[o];n.time+n.duration+.2>=e&&e>=n.time-3&&("click"===n.type?y(e+3-n.time,n.key):h(e,n.time,e+3-n.time,n.duration,n.type,n.key))}};let w,b;window.addEventListener("resize",(()=>{p.width=window.innerWidth})),window.addEventListener("keydown",(e=>{d=e.key})),window.addEventListener("keyup",(()=>{d=null}));let S=0,k=0,v=0,E=0;const q={ArrowUp:document.createElement("img"),ArrowLeft:document.createElement("img"),ArrowRight:document.createElement("img"),ArrowDown:document.createElement("img")},L={rapid:o,hold:t};q.ArrowUp.src=n,q.ArrowLeft.src=a,q.ArrowDown.src=r,q.ArrowRight.src=i;const M=document.createElement("img");function x(e,t,o,n){M.src=L[n];const a=t+100;b.strokeStyle="rapid"===n?"blue":"#add8e6",b.lineWidth=10,b.beginPath(),b.arc(t,30,15.5,0,2*Math.PI),b.arc(o,30,15.5,0,2*Math.PI),b.stroke(),b.beginPath(),b.drawImage(q[e],t-22.5,10,50,50),b.drawImage(M,a,10,75,35),b.drawImage(q[e],o-22.5,10,50,50)}function T(e=[],t=0,o=0){b.clearRect(0,0,w.width,w.height),function(e,t){for(let o=0;o<t;o+=1){const t=o/10;if(t+E>=e&&e>=t-E){const o=k-(e-(t-E))*v,n=t-Math.floor(t)==0;b.beginPath(),b.lineWidth=2,b.strokeStyle="gray",b.fillStyle="rgba(38, 199, 151, 0.741)",b.font="12px serif",b.moveTo(o,0),b.lineTo(o,n?100:60),b.fillText(t,o-3,n?112:72),b.stroke()}}}(t,Number((10*o).toFixed(0))),function(e,t){for(let a=0;a<t.length;a+=1){const r=t[a];if(r.time+r.duration+E>=e&&e>=r.time-E){const t=e-(r.time-E),a=k-t*v;if("click"===r.type)o=r.key,n=a,b.beginPath(),b.drawImage(q[o],n-20.5,10,50,50);else{const t=Number(r.time+r.duration-e-E)*v,o=w.width+t;x(r.key,a,o,r.type)}}}var o,n}(t,e);const n=E*v,a=Math.floor(k-n);b.beginPath(),b.moveTo(a,30),b.lineTo(a-15,0),b.lineTo(a+15,0),b.fillStyle="rgba(38, 199, 151, 0.741)",b.fill()}function P(e){localStorage.setItem("info",JSON.stringify(e))}function D(){const e=localStorage.getItem("info");return JSON.parse(e)}window.addEventListener("resize",(()=>{b.clearRect(0,0,w.width,w.height),w.width=window.innerWidth,S=Math.ceil(w.clientWidth/29),k=w.width,v=k/(S/10),E=S/2/10}));const A=()=>{let e=JSON.parse(localStorage.getItem("maps"));return e||(localStorage.setItem("maps",JSON.stringify([])),e=JSON.parse(localStorage.getItem("maps"))),e};function C(e){const t=A().find((t=>t.id===e));return t?.beatMap}function R({id:e,beatMap:t}){const o=A(),n=o.find((t=>t.id===e));n?n.beatMap=t:o.push({id:e,beatMap:t}),localStorage.setItem("maps",JSON.stringify(o))}function N(e){const t=A().filter((t=>t.id!==e));localStorage.setItem("maps",JSON.stringify(t))}e.p,e.p,e.p,e.p;const U=e=>{if(e>1)return;const t=100*e;document.querySelector(".progress_thumb").style.left=`${t}%`},B=e=>{const t=document.querySelector(".p_container"),o=document.querySelector(".progress_thumb"),n=t.getBoundingClientRect();if(!(e.pageX<n.left||e.pageX>n.width+n.left))return o.style.left=(e.pageX-n.left)/n.width*100+"%",(e.pageX-n.left)/n.width},I=e.p+"031487f472f0d22cdd9d.png";function O(e){document.querySelector("#exit").style.display=e?"inline-block":"none"}function j(e){const t=document.querySelector("#click-image"),o=document.querySelector("#hold-image"),n=document.querySelector("#rapid-image");[t,o,n].includes(e)&&(t.classList.remove("active-prompt"),n.classList.remove("active-prompt"),o.classList.remove("active-prompt"),e.classList.toggle("active-prompt"))}function $(e){const t=document.querySelector("#editor-audio"),o=document.querySelector("#background-video");t.currentTime=e,o.currentTime=e}function _(e){const t=document.querySelector("#editor-audio");document.querySelector("#ptime").textContent=` ${e.toFixed(3)} / ${t.duration}`,document.querySelector("#score").textContent=`${e.toFixed(1)} `}function F(e){const t=document.querySelector(".button-group"),o=document.querySelector("#add-map-form"),n=document.querySelector("#summary-wrapper"),a=t.children;Object.keys(a).forEach((t=>{const r=a[t];if(r.id===e){r.classList.add("active");const e=r.getAttribute("id"),t="selected"===e,a="add"===e;return o.style.display=a?"flex":"none",void(n.style.display=t?"flex":"none")}r.classList.remove("active")}))}function J(e,t,o,n){const a=document.querySelector("#editor-audio"),r=document.querySelector("#background-video"),i=document.querySelector("#background-image"),c=document.querySelector("#map-audio"),d=document.querySelector("#select-name "),s=document.querySelector("#name-edit>input[type='text']"),l=document.querySelector("#map-video"),u=document.querySelector("#map-image");var p;(()=>{const e=document.querySelector(".not-selected"),t=document.querySelector("#selected-summary");e.style.display="none",t.style.display="flex"})(),p=e.id,document.querySelectorAll(".beat-map").forEach((e=>{e.id!==`map-${p}`?e.classList.remove("active"):e.classList.add("active")})),a.src=o,l.style.display="none",u.style.display="none",r.style.display="none",i.style.display="none",d.textContent=e.name,s.value=e.name,c.src=o,"mp4"===t?(r.src=n,r.style.display="block",l.src=n,l.style.display="block",l.play()):(i.style.backgroundImage=`url(${n})`,u.src=n,u.style.display="block",i.style.display="block")}function W(e){document.querySelector(".not-selected").style.display="block",document.querySelector("#selected-summary").style.display="none",document.querySelector("#selected-status").textContent=e,O(!1)}function H(){const e=document.querySelector("#login"),t=document.querySelector("#add-map");document.querySelector("#map-list").style.display="block",t.style.display="grid",e.style.display="none"}function G(){const e=document.querySelector("#login"),t=document.querySelector("#add-map"),o=document.querySelector("#map-list");e.style.display="flex",t.style.display="none",o.style.display="none"}function K(e,t){document.querySelector(`#${t}`).textContent=e}function X(e){const t=document.querySelector("#name-edit-open");document.querySelector("#name-edit").style.display=e?"flex":"none",t.style.display=e?"none":"inline"}function z(e,t){document.querySelector(`#${e}`).style.display=t}function V(e,t,o){document.querySelector(`#${e}`).querySelector("form").style.display=o?"flex":"none",t.innerHTML=o?"&#8595":"&#8593"}const{apiDomain:Q}={dealy:3,timingWindowEarly:.2,timingWindowLate:.1,pointWidth:10,pointSpacing:10,startTime:3,apiDomain:{development:"http://localhost:5000",production:"https://kareokeapi.onrender.com/"}};async function Y({url:e,options:t,headers:o={}}){const n=["localhost","127.0.0.1"].includes(window.location.hostname)?Q.development:Q.production,a=await fetch(`${n}/${e}`,{mode:"cors",credentials:"include",headers:{CSRF_TOKEN:sessionStorage.getItem("csrfToken"),...o},...t});if(!1===a.ok){const e=await a.text();throw new Error(function(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelector("p")?.textContent||"error could not compelte request"}(e))}return a.status,a}async function Z(e,t){const o={method:"get",signal:t},n=await Y({url:`kareoke/get_map?mapID=${e}`,options:o,headers:{}});return await n.json()}async function ee(e,t){const o=await fetch(e,{method:"get",signal:t});return await o.blob()}async function te(e){const t={method:"put",body:JSON.stringify(e)},o=await Y({url:"kareoke/save_map",options:t,headers:{"Content-Type":"application/json"}});return await o.text()}const oe=function(){let e,t,o=0,n=0,a=!1,r=!1,i=1,c=[],d="click",s=0,l=1,u=1;const p={one:"ArrowUp",two:"ArrowRight",three:"ArrowLeft",four:"ArrowDown"},m=(e,t)=>{c=c.filter((t=>t.time!==e)),R({id:t,beatMap:c})};return{getBeatMap:()=>c,setBeatMap:e=>{c=e},progressBarTimeUpdate:a=>{void 0!==a?(n=t*a/i,o=n*i,e=Date.now()-1e3*n):console.log("undefined")},getElapsedTime:()=>o,updateSpeed:t=>{i=t,n=o/i,o=n*i,e=Date.now()-1e3*n},addPrompt:(e,t,o)=>{const n=c.find((t=>t.time===e));if(n&&(m(e,o),n.key===p[t]))return;const a=((e,t,o,n)=>({time:e,type:t,duration:o,key:p[n]}))(e,d,s,t);c.push(a),c.sort(((e,t)=>e.time-t.time)),R({id:o,beatMap:c})},removePrompt:m,pickTime:e=>(n=e/i,o=n*i,!0),checkOccupation:e=>c.find((t=>t.time<e&&t.time+t.duration>=e)),canPlace:(e,t)=>c.find((o=>o.time>e&&o.time<=e+t)),timeStep:e=>{const t=Number(o.toFixed(1));a||n-.1<0&&"backward"===e||(n=(t+("foward"===e?.1:-.1))/i,o=n*i)},switchPrompt:(e,t)=>{d=e,s=t},translateToKey:e=>{let t;switch(e){case"one":t="ArrowUp";break;case"two":t="ArrowLeft";break;case"three":t="ArrowRight";break;case"four":t="ArrowDown"}return t},getPlayRate:()=>i,getStartTime:()=>e,getHoldDuration:()=>l,getRapidDuration:()=>u,getPromptType:()=>d,beatMapDownload:e=>{const t=new Blob(e,{type:"text/plain"});return URL.createObjectURL(t)},getPromptDuration:()=>s,setRapidDuration:e=>{u=e},setPromptDuration:e=>{s=e},setHoldDuration:e=>{l=e},setMoveThump:e=>{r=e},getMoveThumb:()=>r,getPreviousTime:()=>n,setPreviousTime:e=>{n=e},getAudioDuration:()=>t,setAudioDuration:e=>{t=e},getPlay:()=>a,setPlay:e=>{a=e},setElapsedTime:e=>{o=e},getPlayBackRate:()=>i,setStartTime:t=>{e=t},setMoveThumb:e=>{r=e}}}(),ne=function(){let e,t,o,n=new AbortController,a=new AbortController;const r=e=>{o=e,localStorage.setItem("selectedMap",JSON.stringify(e));const t=C(o.id);if(t&&(o.beatMap=t),!t){const e=JSON.parse(o.beatMap);o.beatMap=e,R({id:o.id,beatMap:e})}},i=()=>{localStorage.removeItem("selectedMap"),o=null},c=async({audio:o,background:a})=>{URL.revokeObjectURL(t),URL.revokeObjectURL(e);const[r,i]=await Promise.all([ee(o,n.signal),ee(a,n.signal)]);e=URL.createObjectURL(r),t=URL.createObjectURL(i)},d=e=>e.split(".").pop();return{saveMapRemote:async e=>await te({id:e,column:"beatMap",value:C(e)||[]}),handleGetUserBeatMaps:async()=>await async function(){const e=await Y({url:"kareoke/get_user_maps",options:{method:"get"},headers:{}});return await e.json()}(),handleGetBeatMaps:async(e,t)=>{const o=t.split(" ").filter((e=>""!==e)).join(",");a.abort(),a=new AbortController;const n=await async function(e,t,o){const n={method:"get",signal:o},a=await Y({url:`kareoke/get_published?page=${e}&search=${t}`,options:n,headers:{}});return await a.json()}(e,o,a.signal);return n},getBackgroundUrl:()=>t,getAudioUrl:()=>e,generateBlobUrl:c,getSelectedMap:()=>o,setSelectedMap:r,addBeatMap:e=>{const t=async function(e){const t={method:"post",body:e},o=await Y({url:"kareoke/add_map",options:t,headers:{}});return await o.json()}(e);return t},checkSelectedSong:async()=>{const e=JSON.parse(localStorage.getItem("selectedMap"));if(e){const t=await Z(e.id,n.signal);return r(t),await c(o),!0}return!1},getExtension:d,abortSelection:()=>{n.abort(),n=new AbortController},clearSelectedMap:i,loadMap:async o=>{const n=await Z(o);return await c(n),{mapInfo:n,audioUrl:e,backgroundUrl:t,extension:d(n.background)}},deleteBeatMap:async n=>{const a=await async function(e){const t={method:"delete",body:JSON.stringify({id:e})},o=await Y({url:"kareoke/delete_map",options:t,headers:{"Content-Type":"application/json"}});return await o.text()}(n);return URL.revokeObjectURL(t),URL.revokeObjectURL(e),n===o?.id&&i(),N(n),a},publishMap:async e=>await async function(e){const t={method:"post",body:JSON.stringify({beatMapID:e})},o=await Y({url:"kareoke/publish_request",options:t,headers:{"Content-Type":"application/json"}});return await o.text()}(e),saveMapName:async e=>{if(!o)throw new Error("No map selected");const t=o,n=await te({id:o.id,column:"name",value:e});return t.name=e,{response:n,reload:t===o,extension:d(t.background)}},changeMedia:async(e,t)=>{if(!o)throw new Error("No map selected");const n=o,a=new FormData;a.append("type",e),a.append("media",t),a.append("mapID",o.id);const r=await async function(e){const t={method:"put",body:e},o=await Y({url:"kareoke/change_media",options:t,headers:{}});return await o.text()}(a);return o[e]=r,{newURL:r,reload:o===n,extension:d(r)}}}}(),ae=function(){let e={isLogin:!1};return{getUserData:()=>e,setUserData:(t,o)=>{e[t]=o},handleLogin:async t=>{const o=await async function({email:e,password:t}){const o={body:JSON.stringify({email:e,password:t}),method:"post"},n=await Y({url:"auth/login",options:o,headers:{"Content-Type":"application/json"}});return await n.json()}(t);e={...o,isLogin:!0},sessionStorage.setItem("csrfToken",e.csrfToken),P(e)},handleRegister:async e=>await async function({email:e,password:t,userName:o}){const n={body:JSON.stringify({email:e,password:t,userName:o}),method:"post"},a=await Y({url:"auth/register",options:n,headers:{"Content-Type":"application/json"}});return await a.text()}(e),isLogin:async()=>{const t=D();if(!t)return;const o=await async function({csrfToken:e}){const t={"Content-Type":"application/json",CSRF_TOKEN:e};return await Y({url:"auth/check",options:{method:"get"},headers:t})}(t),n=await o.json();e={...n,isLogin:!0},sessionStorage.setItem("csrfToken",e.csrfToken),P(n)},handleLogout:async()=>{const e=D();return await async function({csrfToken:e}){const t={CSRF_TOKEN:e},o=await Y({url:"auth/logout",options:{method:"post"},headers:t});return await o.text()}(e)},handlePasswordChange:async(t,o)=>{const n=await async function(e,t,o){const n={body:JSON.stringify({email:e,currentPassword:t,newPassword:o}),method:"post"},a=await Y({url:"auth/change_password",options:n,headers:{"Content-Type":"application/json"}});return await a.text()}(e.email,t,o);return n},handleEditAccount:async(t,o,n)=>{const a=await async function(e,t,o,n){const a={body:JSON.stringify({email:t,password:e,column:o,value:n}),method:"post"},r=await Y({url:"auth/change_acount_info",options:a,headers:{"Content-Type":"application/json"}});return await r.text()}(t,e.email,o,n);return a},handleEmailVerifyGeneration:async()=>await async function(){const e=await Y({url:"auth/generate_verify_url",options:{method:"post"}});return await e.text()}()}}();let re=!1,ie=!1,ce=!1;let de;p=document.querySelector(".cplayer"),p.width=window.innerWidth,p.height=215,p.getContext?u=p.getContext("2d"):console.log("canvas not supported"),w=document.querySelector("#time-map"),w.width=window.innerWidth,w.height=150,k=w.width,S=Math.ceil(w.clientWidth/29),v=k/(S/10),E=S/2/10,w.getContext?b=w.getContext("2d"):console.log("canvas not supported"),document.querySelector("#rapid-image").src=o,document.querySelector("#hold-image").src=t,document.querySelector("#click-image").src=I;const se=(e,t,o)=>{ne.generateBlobUrl({audio:e,background:t}).then((()=>{J(ne.getSelectedMap(),o,ne.getAudioUrl(),ne.getBackgroundUrl()),O(!0)}))},le=(e,t)=>{ne.setSelectedMap(e),oe.setBeatMap(ne.getSelectedMap().beatMap),se(e.audio,e.background,t)},ue=e=>{const t=ne.getExtension(e.background),o=e.background;let n=!1,a=!1,r=!1;const{listItem:i,optionButton:c,optionsList:d,saveMap:s,deleteMap:l,clearLocal:u,publishMap:p,mapStatus:m}=function(e,t,o){const n=document.querySelector("#map-list"),a=document.createElement("li");a.id=`map-${e.id}`,a.classList.add("beat-map");const r=document.createElement("span");r.innerHTML="&#x22EF",r.classList.add("map-option");const i=document.createElement("ul");i.classList.add("option-list"),a.append(i);const c=document.createElement("a");c.textContent="Play",c.href=`player.html?song=${e.id}`,c.target="_blank” attribute",i.append(c);const d=document.createElement("li");d.textContent="Save","draft"===e.status&&i.append(d);const s=document.createElement("li");s.textContent="draft"!==e.status?"unpublish":"publish",i.append(s);const l=document.createElement("li");l.textContent="Delete",i.append(l);const u=document.createElement("li");let p;u.textContent=" Clear local",i.append(u),"mp4"===t?(p=document.createElement("video"),p.addEventListener("mouseenter",(e=>{e.target.play()})),p.addEventListener("mouseleave",(e=>{e.target.pause()}))):p=document.createElement("img"),p.classList.add("beat-map-image"),p.src=o,a.appendChild(p);const m=document.createElement("div");m.classList.add("beat-map-text"),a.appendChild(m);const g=document.createElement("div"),y=document.createElement("span");y.classList.add("map-name"),y.textContent=e.name;const h=document.createElement("span");h.className=`${e.status}-status`,"draft"!==e.status&&(h.textContent=e.status),g.append(y,h);const f=document.createElement("span");return f.textContent=`last updated: ${e.dateUpdated}`,m.append(g,f),a.append(r),n.prepend(a),{listItem:a,optionsList:i,optionButton:r,deleteMap:l,saveMap:d,publishMap:s,clearLocal:u,mapName:y,mapStatus:h}}(e,t,o);i.addEventListener("click",(()=>{const o=ne.getSelectedMap();o?.id!==e.id&&(O(!1),function(){const e=document.querySelector(".not-selected"),t=document.querySelector("#selected-summary"),o=document.querySelector("#selected-status");t.style.display="none",e.style.display="flex",o.textContent="Loading..."}(),ne.abortSelection(),le(e,t),oe.setElapsedTime(0),oe.setPreviousTime(0))})),c.addEventListener("click",(e=>{e.stopPropagation(),function(e){const t=e,{display:o}=getComputedStyle(t);t.style.display="none"===o?"block":"none"}(d)})),d.addEventListener("click",(e=>{e.stopPropagation()})),"draft"===e.status&&s.addEventListener("click",(t=>{if(t.stopPropagation(),r)return;s.textContent="Saving...",r=!0;const{id:o}=e;ne.saveMapRemote(o).then((e=>{alert(e)})).finally((()=>{s.textContent="Save",r=!1}))})),l.addEventListener("click",(()=>{n||confirm("All map data will be deleted")&&(n=!0,l.textContent="Deleting...",ne.deleteBeatMap(e.id).then((e=>{i.remove(),null===ne.getSelectedMap()&&W("No map selected"),alert(e)})).finally((()=>{n=!1,l.textContent="delete"})))})),u.addEventListener("click",(()=>{confirm("Local data will be deleted (will revert to remote data)")&&(N(e.id),oe.setBeatMap(JSON.parse(e.beatMap)),alert("local data deleted"))})),p.addEventListener("click",(()=>{a||confirm({draft:"Map will be put up for review and you wont be able to edit it during this period",pending:"Map will be removed from publish queue",published:"Map will no longer be publicly available"}[e.status])&&(a=!0,p.textContent="....",ne.publishMap(e.id).then((t=>{e.status=t})).finally((()=>{a=!1,p.textContent="draft"===e.status?"publish":"unpublish",m.textContent="draft"===e.status?"":e.status,m.className=`${e.status}-status`})))}))},pe=()=>{cancelAnimationFrame(de),oe.setPlay(!1),function(){const e=document.querySelector("#editor-audio"),t=document.querySelector("#background-video"),o=document.querySelector("#play");e.pause(),t.pause(),o.textContent="▶"}()},me=()=>{f(oe.getElapsedTime(),oe.getBeatMap()),T(oe.getBeatMap(),oe.getElapsedTime(),oe.getAudioDuration()),_(oe.getElapsedTime()),((e,t)=>{const o=document.querySelector("#prompt_location"),n=o.getContext("2d");n.clearRect(0,0,o.width,o.height);for(let a=0;a<e.length;a+=1){const r=e[a].time/t*o.width,i="click"===e[a].type?40:0;n.strokeStyle="click"===e[a].type?"red":"hold"===e[a].type?"rgb(12, 240, 240)":"blue",n.beginPath(),n.lineTo(r,i),n.lineTo(r,80),n.stroke()}})(oe.getBeatMap(),oe.getAudioDuration())},ge=()=>{const e=oe.getElapsedTime(),t=oe.getAudioDuration();e>=t?pe():(U(e/t),_(e),f(e,oe.getBeatMap()),T(oe.getBeatMap(),e,t),(()=>{const e=oe.getElapsedTime(),t=oe.getAudioDuration(),o=oe.getPreviousTime(),n=oe.getPlayRate();if(e>=t)return void pe();const a=Number((Date.now()-oe.getStartTime())/1e3);oe.setPreviousTime(a),oe.setElapsedTime(o*n)})(),de=requestAnimationFrame(ge))},ye=()=>{de=requestAnimationFrame(ge),oe.setStartTime(Date.now()-1e3*oe.getPreviousTime()),oe.setPlay(!0),function(e){const t=document.querySelector("#editor-audio"),o=document.querySelector("#background-video"),n=document.querySelector("#play");t.currentTime=e,o.currentTime=e,t.play(),o.play(),n.textContent="⏸"}(oe.getElapsedTime())},he=()=>{ne.checkSelectedSong().then((e=>{if(e){const e=ne.getSelectedMap(),t=ne.getExtension(e.background);return se(e.audio,e.background,t),oe.setBeatMap(ne.getSelectedMap().beatMap),void O(!0)}W("No map selected")})).catch((e=>{console.log(e),W("Error while fetching map"),ne.clearSelectedMap()}))};document.querySelector("#add").addEventListener("click",(e=>{F(e.target.id)})),document.querySelector("#selected").addEventListener("click",(e=>{F(e.target.id)}));const fe=document.querySelector("#add-map-form");fe.addEventListener("submit",(e=>{e.preventDefault();const t=e.submitter;t.disabled=!0;const o=new FormData(fe);ne.addBeatMap(o).then((async e=>{console.log(e);const t=e.map;ue(t),le(t,ne.getExtension(t.background)),fe.reset(),F("selected"),K("","addmap-error")})).catch((e=>{console.log(e),K(e,"addmap-error")})).finally((()=>{t.disabled=!1}))})),document.querySelector("#time_guage").addEventListener("change",(e=>{oe.updateSpeed(Number(e.target.value)),function(e){const t=document.querySelector("#editor-audio"),o=document.querySelector("#background-video");t.playbackRate=e,o.playbackRate=e}(oe.getPlayBackRate())})),document.querySelector("#play").addEventListener("click",(()=>{if(console.log(oe.getPlay()),!1===oe.getPlay())return console.log("hi"),void ye();oe.getPlay()&&pe()})),document.querySelector("#menu").addEventListener("click",(()=>{document.querySelector("#modal").style.display="flex",pe()})),document.querySelector("#exit").addEventListener("click",(()=>{!function(){const e=document.querySelector("#modal"),t=document.querySelector("#map-audio");e.style.display="none",t.pause()}()}));const we=document.querySelector(".get-prompt");we.addEventListener("click",(e=>{if(e.target===we)return;const t=oe.getElapsedTime().toFixed(1);oe.checkOccupation(Number(t),ne.getSelectedMap().id)?console.log("space is occupied by a long prompt"):oe.canPlace(Number(t),oe.getPromptDuration(),ne.getSelectedMap().id)?console.log("cant place that prompt here"):(console.log(`${e.target.id}  time: ${oe.getElapsedTime().toFixed(1)}`),oe.addPrompt(Number(t),e.target.id,ne.getSelectedMap().id),me())})),document.querySelector("#click-image").addEventListener("click",(e=>{oe.switchPrompt("click",0),j(e.target)})),document.querySelector("#hold-image").addEventListener("click",(e=>{oe.switchPrompt("hold",oe.getHoldDuration()),j(e.target)})),document.querySelector("#rapid-image").addEventListener("click",(e=>{oe.switchPrompt("rapid",oe.getRapidDuration()),j(e.target)})),document.querySelector("#r-form").addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(e.target);oe.setRapidDuration(Number(t.get("duration"))),"rapid"===oe.getPromptType()&&oe.setPromptDuration(oe.getRapidDuration())})),document.querySelector("#h-form").addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(e.target);oe.setHoldDuration(Number(t.get("duration"))),"hold"===oe.getPromptType&&oe.setPromptDuration(oe.getHoldDuration())}));const be=document.querySelector(".progress_section");be.addEventListener("mousedown",(e=>{oe.setMoveThumb(!0);const t=B(e);oe.progressBarTimeUpdate(t),me(),$(oe.getElapsedTime())})),be.addEventListener("mouseup",(()=>{oe.setMoveThumb(!1)})),be.addEventListener("mousemove",(e=>{if(oe.getMoveThumb()){const t=B(e);oe.progressBarTimeUpdate(t),me(),$(oe.getElapsedTime())}})),document.querySelector("body").addEventListener("keydown",(e=>{if(oe.getPlay())return;if(!1===["ArrowRight","ArrowLeft"].includes(e.key))return;const t="ArrowRight"===e.key?"foward":"backward";oe.timeStep(t),U(document.querySelector("#editor-audio").currentTime/oe.getAudioDuration()),me(),$(oe.getElapsedTime())})),document.querySelector("#name-edit-open").addEventListener("click",(()=>{X(!0)})),document.querySelector("#name-edit-close").addEventListener("click",(()=>{X(!1)})),document.querySelector("#name-edit").addEventListener("submit",(e=>{if(e.preventDefault(),ce)return;ce=!0;const{name:t,status:o,id:n}=ne.getSelectedMap();if("draft"!==o)return void K("Only draft posts can be edited","editname-error");const a=new FormData(e.target);if(a.get("map-name")===t)return;const r=document.querySelector("#name-edit button");r.disabled=!0,console.log(r),ne.saveMapName(a.get("map-name")).then((({reload:e,extension:t})=>{!function(e,t){document.querySelector(`#map-${e} .map-name`).textContent=t}(n,a.get("map-name")),X(!1),K("","editname-error"),e&&J(ne.getSelectedMap(),t,ne.getAudioUrl(),ne.getBackgroundUrl())})).catch((e=>{console.log(e),K(e,"editname-error")})).finally((()=>{ce=!1,r.disabled=!1}))})),document.querySelector("#background-edit").addEventListener("change",(e=>{if(re)return;const t=e.target.files[0];re=!0,z("background-indicator","block"),ne.changeMedia("background",t).then((({reload:e,extension:t})=>{K("","editbackground-error"),e&&(console.log("reloading"),se(ne.getSelectedMap().audio,ne.getSelectedMap().background,t))})).catch((e=>{K(e,"editbackground-error"),console.log(e)})).finally((()=>{z("background-indicator","none"),re=!1}))})),document.querySelector("#audio-edit").addEventListener("change",(e=>{if(ie)return;const t=e.target.files[0];ie=!0,z("audio-indicator","block"),ne.changeMedia("audio",t).then((({reload:e,extension:t})=>{K("","editaudio-error"),e&&(console.log("reloading"),se(ne.getSelectedMap().audio,ne.getSelectedMap().background,t))})).catch((e=>{K(e,"editaudio-error"),console.log(e)})).finally((()=>{z("audio-indicator","none"),ie=!1}))})),document.querySelector("#open-rapid").addEventListener("click",(e=>{if(""===e.target.dataset.expand)return V("rapid",e.target,!0),void(e.target.dataset.expand="true");""!==e.target.dataset.expand&&(V("rapid",e.target,!1),e.target.dataset.expand="")})),document.querySelector("#open-hold").addEventListener("click",(e=>{if(""===e.target.dataset.expand)return V("hold",e.target,!0),void(e.target.dataset.expand="true");""!==e.target.dataset.expand&&(V("hold",e.target,!1),e.target.dataset.expand="")})),document.querySelector("body").addEventListener("keydown",(e=>{" "===e.key&&"flex"!==getComputedStyle(document.querySelector("#modal")).display&&(!1!==oe.getPlay()?!0===oe.getPlay()&&pe():ye())})),document.querySelector("#login").addEventListener("submit",(e=>{e.preventDefault();const t=e.submitter;t.disabled=!0;const o=new FormData(e.target);ae.handleLogin({email:o.get("email"),password:o.get("password")}).then((async e=>{H(),he(),(await ne.handleGetUserBeatMaps()).forEach((e=>{ue(e)})),console.log(e),F("selected")})).catch((e=>{console.log(e),K(e,"login-error")})).finally((()=>{t.disabled=!1}))})),document.querySelector("#editor-audio").addEventListener("loadedmetadata",(e=>{oe.setAudioDuration(e.target.duration),me()})),ae.isLogin().then((async()=>{ae.getUserData().isLogin?(H(),he(),(await ne.handleGetUserBeatMaps()).forEach((e=>{ue(e)}))):G()})).catch((e=>{console.log(e),G()}))})();